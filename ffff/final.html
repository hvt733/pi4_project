<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Realtime Database</title>

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://kit.fontawesome.com/9f25d43b0a.js" crossorigin="anonymous"></script>
    
    <title>Sensor Status</title>
    <link rel="stylesheet" href="./assert/reset.css">
    <link rel="stylesheet" href="./assert/style.css">
    

    <script type="module">
      let fireDetectedTime = null;
      let fireDetected = false;
      let tempMin = 0;
      let tempMax = 60;
      let humiMin = 0;
      let humiMax = 100;
      let chart1;
      let chart2;

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
      import { getDatabase, ref, set, remove, get, child, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
      // import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
  

      const firebaseConfig = {
          apiKey: "AIzaSyCTv0WFKuNafqszXmI40v_DIOVPkNqp-78",
          authDomain: "monitoring-sensor-4e47e.firebaseapp.com",
          databaseURL: "https://monitoring-sensor-4e47e-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "monitoring-sensor-4e47e",
          storageBucket: "monitoring-sensor-4e47e.appspot.com",
          messagingSenderId: "935434093765",
          appId: "1:935434093765:web:35353ee82daebe23e6dcac",
          measurementId: "G-B6MXC3TY4R"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const dbRef = ref(db); // Trỏ đến root để lấy tất cả các ngày
  
    let chartInstanceTemp = null; // Biến để lưu trữ đối tượng biểu đồ nhiệt độ
    let chartInstanceHumi = null; // Biến để lưu trữ đối tượng biểu đồ độ ẩm




    let fireData; // Biến toàn cục để lưu trữ dữ liệu về lửa





    function saveSensorValues() {
    fetch('r_read_values.php')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }

            const today = new Date();
            const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;

            const updates = {};

            // Cập nhật dữ liệu cho các cảm biến nhiệt độ và độ ẩm
            const sensors = {
                'TemperatureC': data['b_sensor_TempC_values.txt'],
                'TemperatureF': data['b_sensor_TempF_values.txt'],
                'Humidity': data['c_sensor_Humi_values.txt']
            };

            // Lấy threshold hiện tại từ Firebase
            get(ref(db, `/${dateKey}`)).then((snapshot) => {
                const todayData = snapshot.exists() ? snapshot.val() : {};

                Object.keys(sensors).forEach(sensorType => {
                    const values = sensors[sensorType];
                    const todayThresholds = todayData[sensorType] || {};

                    updates[sensorType] = {
                        'MIN': `${values.min || 'N/A'}`,
                        'MAX': `${values.max || 'N/A'}`,
                        'AVG': `${values.average || 'N/A'}`,
                        'MIN_TIME': `${values.time_min || 'N/A'}`,
                        'MAX_TIME': `${values.time_max || 'N/A'}`,
                        'HIGH_THRESHOLD': todayThresholds['HIGH_THRESHOLD'] || 60, // Default 60 nếu không có
                        'LOW_THRESHOLD': todayThresholds['LOW_THRESHOLD'] || 0   // Default 0 nếu không có
                    };
                });
                
                // Dữ liệu của cảm biến lửa
                const fireData = data['a_sensor_Fire_values.txt'];
                updates['Fire'] = {
                    isFire: fireData?.isFire === '1',
                    duration: fireData?.duration || '00:00:00',
                    time_detected: fireData?.time_detected || 'N/A',
                    currentTime: fireData?.current || 'N/A',
                    date_detected: fireData?.date_detected || 'N/A'
                };
              

                const validUpdates = {};
                for (const [key, value] of Object.entries(updates)) {
                    const sanitizedKey = key.replace(/[/\[\].#$]/g, '_');
                    validUpdates[sanitizedKey] = value;
                }

                set(ref(db, `/${dateKey}`), validUpdates)
                    .then(() => {
                        console.log('Sensor values saved successfully after reset!');
                    })
                    .catch((error) => {
                        console.error('Error saving sensor values after reset: ', error);
                    });

            }).catch((error) => {
                console.error('Error fetching today\'s thresholds:', error);
            });
        })
        .catch((error) => {
            console.error('Error fetching sensor values:', error);
        });
}


// Sự kiện click của nút reset_fire
const reset_fire = document.getElementById('reset_fire');
reset_fire.addEventListener('click', function() {
    // Hàm để thực hiện hai fetch cùng một lúc
    function fetchData() {
        // Gửi yêu cầu đến r_reset.php và r_read_values.php đồng thời
        return Promise.all([
            fetch('r_reset.php').then(response => response.text()),
            fetch('r_read_values.php').then(response => response.json())
        ]);
    }

    // Gọi hàm và xử lý kết quả
    fetchData()
        .then(([resetResponse, sensorData]) => {
            // Xử lý kết quả từ r_reset.php
            alert('Fire data has been reset.');

            // Kiểm tra lỗi và xử lý dữ liệu từ r_read_values.php
            if (sensorData.error) {
                console.error('Error:', sensorData.error);
                return;
            }

            const fireData = sensorData['a_sensor_Fire_values.txt'];
            const today = new Date();
            const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
            const start_time = fireData?.time_detected || 'N/A';
            const end_time = fireData?.current || 'N/A';
            const temp_AVG = fireData?.avg_temp_during_fire || 'N/A';
            
            const temp_Max = fireData?.temp_max_in_fire || 'N/A';
            const temp_Min = fireData?.temp_min_in_fire || 'N/A';

            const temp_time_Max = fireData?.time_min_in_fire || 'N/A';
            const temp_time_Min = fireData?.time_max_in_fire || 'N/A';


            console.log(temp_time_Max);
            console.log(fireData?.max_in_ftime_max_in_fireire);
            // Lưu log trực tiếp lên Firebase
            const fireLogRef = ref(db, `/Fire_Log/${dateKey}/${start_time}`);
            get(fireLogRef).then((snapshot) => {
                if (!snapshot.exists()) {
                    set(fireLogRef, {
                        start_time: start_time,
                        end_time: end_time,
                        isFire: true,
                        AVG: temp_AVG,
                        MAX: temp_Min,
                        MIN: temp_Min,
                        TIME_MAX: temp_time_Max,
                        TIME_MIN: temp_time_Min
                        
                        // temp_AVG: temp_AVG  // Thêm temp_AVG vào log
                    }).then(() => {
                        console.log('Fire log saved successfully to Firebase!');
                    }).catch((error) => {
                        console.error('Error saving fire log to Firebase:', error);
                    });
                } else {
                    console.log('Log with this start time already exists.');
                }
            }).catch((error) => {
                console.error('Error checking existing log:', error);
            });
        })
        .catch((error) => {
            console.error('Error:', error);
        });
});






// Xử lý sự kiện khi nhấn nút reset
// document.getElementById('reset_fire').addEventListener('click', function() {
//     fetch('r_reset.php')
//         .then(response => response.text())
//         .then(data => {
//             // console.log(data);  // Xem kết quả từ PHP script
//             alert('Fire data has been reset.');
//         })
//         .catch(error => {
//             console.error('Error:', error);
//         });
// });
// // Sự kiện click của nút reset_fire
// const reset_fire = document.getElementById('reset_fire');
// reset_fire.addEventListener('click', function() {
//     // Hàm để thực hiện hai fetch cùng một lúc
//     function fetchData() {
//         // Gửi yêu cầu đến r_reset.php và r_read_values.php đồng thời
//         return Promise.all([
//             fetch('r_reset.php').then(response => response.text()),
//             fetch('r_read_values.php').then(response => response.json())
//         ]);
//     }

//     // Gọi hàm và xử lý kết quả
//     fetchData()
//         .then(([resetResponse, sensorData]) => {
//             // Xử lý kết quả từ r_reset.php
//             alert('Fire data has been reset.');

//             // Kiểm tra lỗi và xử lý dữ liệu từ r_read_values.php
//             if (sensorData.error) {
//                 console.error('Error:', sensorData.error);
//                 return;
//             }

//             const fireData = sensorData['a_sensor_Fire_values.txt'];
//             const today = new Date();
//             const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
//             const start_time = fireData?.time_detected || '00:00:00';
//             const end_time = fireData?.current || '00:00:00';
//             // const temp_AVG = fireData?.avg_temp_during_fire || 'N/A';

//             // Lưu log trực tiếp lên Firebase
//             const fireLogRef = ref(db, `/Fire_Log/${dateKey}/${start_time}`);
//             get(fireLogRef).then((snapshot) => {
//                 if (!snapshot.exists()) {
//                     set(fireLogRef, {
//                         start_time: start_time,
//                         end_time: end_time,
//                         isFire: true,
//                         // AVG: temp_AVG
//                         // temp_AVG: temp_AVG  // Thêm temp_AVG vào log
//                     }).then(() => {
//                         console.log('Fire log saved successfully to Firebase!');
//                     }).catch((error) => {
//                         console.error('Error saving fire log to Firebase:', error);
//                     });
//                 } else {
//                     console.log('Log with this start time already exists.');
//                 }
//             }).catch((error) => {
//                 console.error('Error checking existing log:', error);
//             });
//         })
//         .catch((error) => {
//             console.error('Error:', error);
//         });
// });




// document.getElementById('reset_fire').addEventListener('click', function() {
//     fetch('r_reset.php', { method: 'POST', body: new URLSearchParams('reset_fire=true') })
//         .then(response => response.text()) // Đọc phản hồi dưới dạng text
//         .then(data => {
//             console.log('Response data:', data); // Hiển thị dữ liệu phản hồi

//             // Cập nhật trạng thái của boxFire
//             const boxFire = document.getElementById('boxFire');
//             if (data.includes('a_fire_sensor.py executed successfully')) {
//                 boxFire.style.backgroundColor = 'blue'; // Đặt màu xanh cho boxFire
//             } else {
//                 console.error('Error:', data);
//             }
//         })
//         .catch(error => {
//             console.error('Error:', error);
//         });
// });


// document.getElementById('reset_fire').addEventListener('click', function() {
//     // Thực hiện fetch để reset dữ liệu
//     fetch('r_reset.php')
//         .then(response => response.json())
//         .then(data => {
//             if (data.error) {
//                 console.error('Error:', data.error);
//                 return;
//             }

//             const fireData = data['a_sensor_Fire_values.txt'];
//             const today = new Date();
//             const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
//             const start_time = fireData?.time_detected || 'N/A';
//             const end_time = fireData?.current || 'N/A';
//             const temp_vg = fireData?.avg_temp_during_fire || 'N/A';

//             // Lưu log trực tiếp lên Firebase
//             const fireLogRef = ref(db, `/Fire_Log/${dateKey}/${start_time}`);
//             // console.log(dateKey);
//             return get(fireLogRef).then((snapshot) => {
//                 if (!snapshot.exists()) {
//                     return set(fireLogRef, {
//                         start_time: start_time,
//                         end_time: end_time,
//                         isFire: true,
//                         temp_Avg: temp_vg
//                     });
//                 } else {
//                     console.log('Log with this start time already exists.');
//                     // Nếu đã có log với start_time này, không cần phải set lại
//                 }
//             });
//         })
//         .then(() => {
//             console.log('Fire log saved successfully to Firebase!');
//         })
//         .catch(error => {
//             console.error('Error:', error);
//         });
// });







document.getElementById('push_thresholds').addEventListener('click', function() {
    // Thu thập các giá trị từ các input
    const tempCMax = document.getElementById('tempCMax')?.value;
    const tempCMin = document.getElementById('tempCMin')?.value;

    const tempFMax = document.getElementById('tempFMax')?.value;
    const tempFMin = document.getElementById('tempFMin')?.value;

    const humiMax = document.getElementById('humiMax')?.value;
    const humiMin = document.getElementById('humiMin')?.value;

    if (tempCMax === undefined || tempFMax === undefined || humiMax === undefined ||
        tempCMin === undefined || tempFMin === undefined || humiMin === undefined) {
        console.error('Một hoặc nhiều giá trị input không tồn tại.');
        return;
    }

    console.log('Các giá trị thresholds:', tempCMax, tempFMax, humiMax, tempCMin, tempFMin, humiMin);

    // Lấy ngày hiện tại
    const today = new Date();
    let dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
    dateKey = dateKey.replace(/[\.\#\$\[\]]/g, '_'); // Thay thế các ký tự đặc biệt bằng dấu gạch dưới

    // Tạo object với các giá trị thresholds
    const thresholdsC = {
        HIGH_THRESHOLD: tempCMax,
        LOW_THRESHOLD: tempCMin
    };
    
    const thresholdsF = {
        HIGH_THRESHOLD: tempFMax,
        LOW_THRESHOLD: tempFMin
    };

    const thresholdsH = {
        HIGH_THRESHOLD: humiMax,
        LOW_THRESHOLD: humiMin
    };

   // Đẩy dữ liệu lên Firebase
   set(ref(db, `${dateKey}/TemperatureC`), thresholdsC)
        .then(() => {
            console.log('TemperatureC thresholds updated successfully!');
            document.getElementById('tempCMax').value = "";
            document.getElementById('tempCMin').value = "";
            window.location.reload(); // Reload lại trang sau khi cập nhật thành công
        })
        .catch(error => console.error('Error updating TemperatureC thresholds: ', error));

    set(ref(db, `${dateKey}/TemperatureF`), thresholdsF)
        .then(() => {
            console.log('TemperatureF thresholds updated successfully!');
            document.getElementById('tempFMax').value = "";
            document.getElementById('tempFMin').value = "";
            window.location.reload(); // Reload lại trang sau khi cập nhật thành công
        })
        .catch(error => console.error('Error updating TemperatureF thresholds: ', error));

    set(ref(db, `${dateKey}/Humidity`), thresholdsH)
        .then(() => {
            console.log('Humidity thresholds updated successfully!');
            document.getElementById('humiMax').value = "";
            document.getElementById('humiMin').value = "";
            window.location.reload(); // Reload lại trang sau khi cập nhật thành công
        })
        .catch(error => console.error('Error updating Humidity thresholds: ', error));
});


function loadThresholds_placeholder() {
    console.log("Function loadThresholds_placeholder called");  // Check if function is called

    const today = new Date();
    const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;

    const dbRef = ref(db, `/${dateKey}`);
    get(dbRef).then((snapshot) => {
        console.log("Fetched data from Firebase");  // Check if data fetching is initiated

        if (snapshot.exists()) {
            const data = snapshot.val();
            console.log("Data exists in Firebase:", data.TemperatureC.HIGH_THRESHOLD);  // Log the entire data object

            // Set placeholders with values from Firebase
            document.getElementById('tempCMax').placeholder = data.TemperatureC?.HIGH_THRESHOLD;
            document.getElementById('tempCMin').placeholder = data.TemperatureC?.LOW_THRESHOLD ;

            document.getElementById('tempFMax').placeholder = data.TemperatureF?.HIGH_THRESHOLD;
            document.getElementById('tempFMin').placeholder = data.TemperatureF?.LOW_THRESHOLD ;

            document.getElementById('humiMax').placeholder = data.Humidity?.HIGH_THRESHOLD;
            document.getElementById('humiMin').placeholder = data.Humidity?.LOW_THRESHOLD;
        } else {
            console.log("No data available for today.");  // Log when no data is found
        }
    }).catch((error) => {
        console.error('Error fetching data:', error);  // Log errors
    });
}







// const maxValues = {
//     tempCMax: 60,
//     tempFMax: 100,
//     humiMax: 100,
//     tempCMin: 0,
//     tempFMin: 0,
//     humiMin: 0
// };

// // Cập nhật giá trị cho các ô nhập liệu
// document.getElementById('tempCMax').value = maxValues.tempCMax;
// document.getElementById('tempFMax').value = maxValues.tempFMax;
// document.getElementById('humiMax').value = maxValues.humiMax;
// document.getElementById('tempCMin').value = maxValues.tempCMin;
// document.getElementById('tempFMin').value = maxValues.tempFMin;
// document.getElementById('humiMin').value = maxValues.humiMin;



// // Hàm để kiểm tra và xóa tệp tin nếu thời gian hiện tại đã đạt đến 14:29:00
// function checkAndDeleteFiles() {
//     // Lấy thời gian hiện tại
//     const now = new Date();
//     const currentTime = now.toTimeString().substring(0, 8); // Lấy thời gian hiện tại theo định dạng HH:MM

//     // Thời gian cụ thể để thực hiện xóa
//     const targetTime = '14:33:20';

//     // So sánh thời gian hiện tại với thời gian mục tiêu
//     if (currentTime === targetTime) {
//         // Gọi file PHP để xóa tệp tin
//         fetch('/sensor_values/r_delete_txt.php')
//             .then(response => response.json())
//             .then(data => {
//                 if (data.error) {
//                     console.error('Error:', data.error);
//                 } else {
//                     console.log('Files deleted successfully!');
//                 }
//             })
//             .catch((error) => {
//                 console.error('Error deleting files:', error);
//             });
//     }
// }

// // Thực thi hàm kiểm tra ngay khi trang được tải
// window.onload = function() {
//     checkAndDeleteFiles();
//     // Cài đặt một interval để kiểm tra mỗi giây
//     setInterval(checkAndDeleteFiles, 1000); // 1000 milliseconds = 1 second
// };















function removeOldData() {
        const dbRef = ref(db, 'sensors');
        get(dbRef)
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const dates = Object.keys(data);
                    const today = new Date();
                    const currentDateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
                    const thirtyOneDaysAgo = new Date(today.setDate(today.getDate() - 31));
                    const oldDateKey = `${thirtyOneDaysAgo.getFullYear()}-${thirtyOneDaysAgo.getMonth() + 1}-${thirtyOneDaysAgo.getDate()}`;

                    if (dates.includes(oldDateKey)) {
                        remove(child(dbRef, oldDateKey))
                            .then(() => {
                                console.log(`Old data from ${oldDateKey} removed successfully!`);
                            })
                            .catch((error) => {
                                console.error('Error removing old data: ', error);
                            });
                    }
                } else {
                    console.log("No data available");
                }
            })
            .catch((error) => {
                console.error('Error getting data: ', error);
            });
    }































    function updateBox(data) {
      // console.log('Fetched data:', data); // Kiểm tra dữ liệu nhận được

      // Lấy ngày hiện tại
      const today = new Date();
      const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;

      // Kiểm tra nếu dữ liệu có ngày hiện tại và thuộc tính Fire
      if (data && data[dateKey] && data[dateKey].Fire) {
          const fireData = data[dateKey].Fire;
          
          const statusBox = document.getElementById('statusBox1');
          const text_noti_sensor_fire = document.getElementById('text_status1');
          const time_detected = document.getElementById('time_detected');
          const fire_duration = document.getElementById('fire_duration');

          // Kiểm tra trạng thái lửa
          if (fireData.isFire) {
              statusBox.style.backgroundColor = 'red';
              text_noti_sensor_fire.textContent = 'Có lửa';

              // Hiển thị thời gian phát hiện và thời gian cháy
              date_detected.textContent = `Date detected: ${fireData.date_detected}`;
              time_detected.textContent = `Time detected: ${fireData.time_detected}`;
              fire_duration.textContent = `Fire duration: ${fireData.duration}`; // Hiển thị thời gian cháy
          } else {
              statusBox.style.backgroundColor = 'green';
              text_noti_sensor_fire.textContent = 'Không có lửa'; 
              date_detected.textContent = `Date detected: `;
              time_detected.textContent = 'Time detected:';
              fire_duration.textContent = 'Fire duration: ';
          }
      } else {
          console.error('Dữ liệu không hợp lệ hoặc không có dữ liệu về lửa:', data);
      }
  }

 

function fetchDataFromFirebase() {
  onValue(dbRef, (snapshot) => {
    const data = snapshot.val();
    // console.log('Data from Firebase:', data); // Check data
    
    if (data) {
      /* Update data to all funtion 
          Box show Fire Sensor 
          Chart show Temp,Humi, Smoke Sensors
          Table Information of Sensor (Temperature, Humidity, Smoke)
          Table Fire_Log)
      */
      updateBox(data);
      updateChart(data);
      updateTable(data);  
      updateTable2(data); 

    } else {
      console.error('Không có dữ liệu từ Firebase');
    }
  }, (error) => {
    console.error('Lỗi khi lấy dữ liệu từ Firebase:', error);
  });
}


    function updateChart(data) {
      // console.log(data);
  
      // Kiểm tra dữ liệu có phải là đối tượng không
      if (typeof data !== 'object' || data === null) {
        console.error('Dữ liệu không hợp lệ:', data);
        return;
      }
  
      const labels = [];
      const tempMinValues = [];
      const tempMaxValues = [];
      const tempAvgValues = [];
  
      const humiMinValues = [];
      const humiMaxValues = [];
      const humiAvgValues = [];
  
      // Lặp qua tất cả các ngày và thu thập dữ liệu
      for (const dateKey in data) {
        if (dateKey !== 'Fire_Log'){
          const dayData_Temp = data[dateKey]['TemperatureC']; // Lấy dữ liệu của loại cảm biến 'Temperature' cho từng ngày
          const dayData_Humi = data[dateKey]['Humidity']; // Lấy dữ liệu của loại cảm biến 'Humidity' cho từng ngày

          labels.push(dateKey); // Thêm ngày vào danh sách nhãn
          
          if (dayData_Temp) {
            tempMinValues.push(dayData_Temp.MIN || 0); // Thêm giá trị MIN vào danh sách dữ liệu
            tempMaxValues.push(dayData_Temp.MAX || 0); // Thêm giá trị MAX vào danh sách dữ liệu
            tempAvgValues.push(dayData_Temp.AVG || 0); // Thêm giá trị AVG vào danh sách dữ liệu
          }

          if (dayData_Humi) {
            humiMinValues.push(dayData_Humi.MIN || 0); // Thêm giá trị MIN vào danh sách dữ liệu
            humiMaxValues.push(dayData_Humi.MAX || 0); // Thêm giá trị MAX vào danh sách dữ liệu
            humiAvgValues.push(dayData_Humi.AVG || 0); // Thêm giá trị AVG vào danh sách dữ liệu
          }
        }
        
      }
  
      // console.log('Ngày (labels):', labels);
      // console.log('Temp Min Values:', tempMinValues);
      // console.log('Temp Max Values:', tempMaxValues);
      // console.log('Temp Avg Values:', tempAvgValues);

      // console.log('Humi Min Values:', humiMinValues);
      // console.log('Humi Max Values:', humiMaxValues);
      // console.log('Humi Avg Values:', humiAvgValues);
  
      const ctx1 = document.getElementById('myChart3').getContext('2d');
      const ctx2 = document.getElementById('myChart4').getContext('2d');

      if (chartInstanceTemp) {
        chartInstanceTemp.destroy(); // Hủy biểu đồ cũ nếu tồn tại
      }
      if (chartInstanceHumi) {
        chartInstanceHumi.destroy(); // Hủy biểu đồ cũ nếu tồn tại
      }
  
      const tempData = {
        labels: labels,
        datasets: [
          {
            label: 'Temp AVG',
            data: tempAvgValues,
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgb(255, 99, 132)',
            borderWidth: 1,
          },
          {
            label: 'Temp Max',
            data: tempMaxValues,
            backgroundColor: 'rgba(255, 159, 64, 0.2)',
            borderColor: 'rgb(255, 159, 64)',
            borderWidth: 1,
          },
          {
            label: 'Temp MIN',
            data: tempMinValues,
            backgroundColor: 'rgba(255, 205, 86, 0.2)',
            borderColor: 'rgb(255, 205, 86)',
            borderWidth: 1,
          }
        ]
      };
  
      const humiData = {
        labels: labels,
        datasets: [
          {
            label: 'Humi AVG',
            data: humiAvgValues,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgb(54, 162, 235)',
            borderWidth: 1,
          },
          {
            label: 'Humi Max',
            data: humiMaxValues,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgb(75, 192, 192)',
            borderWidth: 1,
          },
          {
            label: 'Humi MIN',
            data: humiMinValues,
            backgroundColor: 'rgba(153, 102, 255, 0.2)',
            borderColor: 'rgb(153, 102, 255)',
            borderWidth: 1,
          }
        ]
      };
  
      const config_Temp = {
        type: 'bar',
        data: tempData,
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Dữ liệu cảm biến Nhiệt độ'
            }
          }
        },
      };

      const config_Humi = {
        type: 'bar',
        data: humiData,
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Dữ liệu cảm biến Độ ẩm'
            }
          }
        },
      };

      chartInstanceTemp = new Chart(ctx1, config_Temp); // Khởi tạo biểu đồ mới cho nhiệt độ
      chartInstanceHumi = new Chart(ctx2, config_Humi); // Khởi tạo biểu đồ mới cho độ ẩm
    } 
  window.onload = function() {
      // Tạo nhãn cho Biểu đồ
      const labels = ['0', '5', '10', '15', '20', '25', '30', '35', '40', '45', '50', '55', '60'];
      
      // Cấu hình cho Biểu đồ Nhiệt độ
      const data1 = {
          labels: labels,
          datasets: [{
              label: 'Biểu đồ nhiệt độ (°C)',
              data: Array(labels.length).fill(0),
              fill: false,
              borderColor: 'rgb(255, 99, 132)',
              tension: 0.1,
              borderWidth: 2, // Thay đổi độ dày của đường kẻ
              yAxisID: 'y-axis-1'
          }, {
              label: 'Biểu đồ nhiệt độ (°F)',
              data: Array(labels.length).fill(0),
              fill: false,
              borderColor: 'rgb(54, 162, 235)',
              tension: 0.1,
              borderWidth: 2, // Thay đổi độ dày của đường kẻ
              yAxisID: 'y-axis-2'
          }]

      };

      // Cấu hình cho Biểu đồ Độ ẩm
      const data2 = {
          labels: labels,
          datasets: [{
              label: 'Biểu đồ độ ẩm (%)',
              data: Array(labels.length).fill(0),
              fill: false,
              borderColor: 'rgb(75, 192, 192)',
              tension: 0.1,
              yAxisID: 'y-axis-1'
          }]
      };

      // Cấu hình cho Biểu đồ Nhiệt độ
      const config1 = {
          type: 'line',
          data: data1,
          options: {
              scales: {
                  'y-axis-1': {
                      type: 'linear',
                      position: 'left',
                      ticks: {
                          callback: function(value) {
                              return value + '°C';
                          },
                          min: tempMin,
                          max: tempMax
                      },
                      scaleLabel: {
                          display: true,
                          labelString: 'Nhiệt độ (°C)'
                      }
                  },
                  'y-axis-2': {
                      type: 'linear',
                      position: 'right',
                      ticks: {
                          callback: function(value) {
                              return value + '°F';
                          },
                          min: (tempMin * 9/5) + 32,
                          max: (tempMax *  9/5) + 32
                      },
                      scaleLabel: {
                          display: true,
                          labelString: 'Nhiệt độ (°F)'
                      }
                  }
              },
              plugins: {
                  datalabels: {
                      display: true,
                      color: 'black',
                      align: 'top',
                      formatter: function(value) {
                          return value;
                      }
                  }
              }
          }
      };
      // Cấu hình cho Biểu đồ Độ ẩm
      const config2 = {
          type: 'line',
          data: data2,
          options: {
              scales: {
                  'y-axis-1': {
                    type: 'linear',
                    position: 'left',
                    min: humiMin,
                    max: humiMax,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Độ ẩm (%)'
                    }
                }
              },
              plugins: {
                  datalabels: {
                      display: true,
                      color: 'black',
                      align: 'top',
                      formatter: function(value) {
                          return value;
                      }
                  }
              }
          }
      };

      const ctx1 = document.getElementById('myChart1').getContext('2d');
      const ctx2 = document.getElementById('myChart2').getContext('2d');
      
      chart1 = new Chart(ctx1, config1);
      chart2 = new Chart(ctx2, config2);

      function updateCharts() {
            const now = new Date();
            const formattedTime = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;

            fetch('b_temp_humi_status.php')
                .then(response => response.json())
                .then(data => {
                    // console.log('Data received:', data)
                    const tempCValue = parseFloat(data['b_sensor_TempC_values.txt']); ;  
                    const tempFValue = parseFloat(data['b_sensor_TempF_values.txt']); ;  
                    const humidityValue = parseFloat(data['c_sensor_Humi_values.txt']);
                    
                    // Cập nhật Biểu đồ Nhiệt độ C
                    data1.datasets[0].data.shift();
                    data1.datasets[0].data.push(tempCValue);
                    data1.labels.shift();
                    data1.labels.push(formattedTime);

                    // Cập nhật Biểu đồ Nhiệt độ F
                    data1.datasets[1].data.shift();
                    data1.datasets[1].data.push(tempFValue);
                    chart1.update();

                    // Cập nhật Biểu đồ Độ ẩm
                    data2.datasets[0].data.shift();
                    data2.datasets[0].data.push(humidityValue);
                    data2.labels.shift();
                    data2.labels.push(formattedTime);
                    chart2.update();
                })
                .catch(error => console.error('Error:', error));
        }

      setInterval(saveSensorValues, 1000);     // Update Database
      setInterval(updateBox, 1000);             // Update Box Fire in Main html
      setInterval(updateCharts, 1000);          // Update Box Temp & Humi in Main html
      fetchDataFromFirebase();                  // Update 2 Chart Temp & Humi in Chart Bar html
      loadThresholds_placeholder();
    };
    
    function showDiv(divNumber) {
        // Ẩn tất cả các div
        document.querySelectorAll('.bottom_content').forEach(div => {
            div.style.display = 'none';
        });

        // Hiển thị div tương ứng với số nút bấm
        document.getElementById(`dev${divNumber}`).style.display = 'block';
      }

      // Gán sự kiện onclick cho các nút bấm
      document.querySelectorAll('.menu_left li').forEach((item, index) => {
          item.addEventListener('click', () => showDiv(index + 1));
      });

      showDiv(1);

    // Gán sự kiện onclick cho các nút bấm
    document.getElementById('infor_Table').addEventListener('click', () => {
        document.getElementById('table1').style.display = 'block';
        document.getElementById('table2').style.display = 'none';
    });

    document.getElementById('alarm_Table').addEventListener('click', () => {
        document.getElementById('table1').style.display = 'none';
        document.getElementById('table2').style.display = 'block';
    });
    function updateTable(data) {
          // Tìm phần tử bảng
          const table1 = document.getElementById("myTable");

          // Xoá các hàng cũ (nếu cần)
          table1.innerHTML = `
            <tr>
              <th rowspan="3">STT</th>
              <th rowspan="3">Date</th>
              <th rowspan="3" colspan="2">Name Sensor</th>
              <th colspan="5">Specification</th>
            </tr>
            <tr>
              <th colspan="2">Min - Time</th>
              <th colspan="2">Max - Time</th>
              <th>AVG</th>
            </tr>
            <tr>
              <th>Min</th>
              <th>Time</th>
              <th>Max</th>
              <th>Time</th>
              <th>Value</th>
            </tr>
          `;

          // Biến đếm STT
          let rowIndex = 1;

          Object.entries(data)
            .filter(([date]) => date !== 'Fire_Log') // Loại bỏ đối tượng 'Fire_Log'
            .forEach(([date, sensorData]) => {
            // Tạo hàng mới cho ngày hiện tại
            const row = table1.insertRow();
            
            row.innerHTML = `
                <th rowspan="4">${rowIndex++}</th>
                <th rowspan="4">${date}</th>
                <th rowspan="2">Temp</th>
                <td>(°C)</td>
                <td>${sensorData.TemperatureC?.MIN || 'N/A'}</td>
                <td>${sensorData.TemperatureC?.MIN_TIME || 'N/A'}</td>
                <td>${sensorData.TemperatureC?.MAX || 'N/A'}</td>
                <td>${sensorData.TemperatureC?.MAX_TIME || 'N/A'}</td>
                <td>${sensorData.TemperatureC?.AVG ? parseFloat(sensorData.TemperatureC.AVG).toFixed(2) : 'N/A'}</td>
            `;

            const row2 = table1.insertRow();
            row2.innerHTML = `
                <td>(°F)</td>
                <td>${sensorData.TemperatureF?.MIN || 'N/A'}</td>
                <td>${sensorData.TemperatureF?.MIN_TIME || 'N/A'}</td>
                <td>${sensorData.TemperatureF?.MAX || 'N/A'}</td>
                <td>${sensorData.TemperatureF?.MAX_TIME || 'N/A'}</td>
                <td>${sensorData.TemperatureF?.AVG ? parseFloat(sensorData.TemperatureF.AVG).toFixed(2) : 'N/A'}</td>
            `;

            const row3 = table1.insertRow();
            row3.innerHTML = `
                <td colspan="2">Humidity (%)</td>
                <td>${sensorData.Humidity?.MIN || 'N/A'}</td>
                <td>${sensorData.Humidity?.MIN_TIME || 'N/A'}</td>
                <td>${sensorData.Humidity?.MAX || 'N/A'}</td>
                <td>${sensorData.Humidity?.MAX_TIME || 'N/A'}</td>
                <td>${sensorData.Humidity?.AVG ? parseFloat(sensorData.Humidity.AVG).toFixed(2) : 'N/A'}</td>
            `;

            const row4 = table1.insertRow();
            row4.innerHTML = `
                <td colspan="2">Smoke (%)</td>
                <td>${sensorData.Smoke?.MIN || 'N/A'}</td>
                <td>${sensorData.Smoke?.MIN_TIME || 'N/A'}</td>
                <td>${sensorData.Smoke?.MAX || 'N/A'}</td>
                <td>${sensorData.Smoke?.MAX_TIME || 'N/A'}</td>
                <td>${sensorData.Smoke?.AVG ? parseFloat(sensorData.Smoke.AVG).toFixed(2) : 'N/A'}</td>
            `;
          });

    }

    function updateTable2(data) {
          // Tìm phần tử bảng
          const table2 = document.getElementById("alarmTable");

          // Xoá các hàng cũ (nếu cần)
          table2.innerHTML = `
            <tr>
              <th>STT</th>
              <th>Date</th>
              <th>Sensors</th>
              <th>True/False</th>
              <th>Start Time</th>
              <th>End Time</th>
              <th>Duration</th>
              <th>AVG</th>
            </tr>
          `;

          // Biến đếm STT
          let rowIndex = 1;
          function timeToSeconds(time) {
              const [hours, minutes, seconds] = time.split(':').map(Number); // Sửa lỗi cú pháp và đảm bảo chuyển đổi thành số
              return hours * 3600 + minutes * 60 + seconds;
          }

          function secondsToTime(seconds) {
              const hours = Math.floor(seconds / 3600);
              const minutes = Math.floor((seconds % 3600) / 60);
              const secs = seconds % 60;
              return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
          }


          Object.entries(data)
          .filter(([key]) => key === 'Fire_Log')
          .forEach(([key, fireLog]) => {
            // Lặp qua tất cả các mục nhập ngày trong Fire_Log
            Object.entries(fireLog).reverse().forEach(([date, timeData]) => {
              // Lặp qua các mục thời gian bên trong mỗi ngày
              Object.entries(timeData).reverse().forEach(([time, logData]) => {
                const row = table2.insertRow();
                const start_time_Second = timeToSeconds(logData.start_time || '00:00:00'); // Thêm kiểm tra nếu start_time không có
                const end_time_Second = timeToSeconds(logData.end_time || '00:00:00'); // Thêm kiểm tra nếu end_time không có
                
                const duration = secondsToTime(end_time_Second - start_time_Second);
                // console.log(logData);
                row.innerHTML = `
                  <th>${rowIndex++}</th>
                  <th>${date || 'N/A'}</th>
                  <th>Fire</th>
                  <td>${logData.isFire !== undefined ? logData.isFire : 'N/A'}</td>
                  <td>${logData.start_time || 'N/A'}</td>
                  <td>${logData.end_time || 'N/A'}</td>
                  <td>${duration || 'N/A'}</td>
                  <td>${parseFloat(logData.temp_Avg).toFixed(2) || 'N/A'}</td>
                  <td class="red_alarm">Dangerous</td>
                `;
              });
            });
  });



    }

   
  </script>
</head>
<body>
  <div class="main_content">
    <div class="container-fluid">
      <div class="row">

        <!-- LEFT -->
        <div class="col-2">
          <div class="task_table">
            <div class="logo_part">
              <div class="image_company">
                <img src="./assert/img/logo.png" alt="">
              </div>
              <div class="title">
                <h3>Monitoring Sensor</h3>
              </div>
            </div>

            <div class="menu_left">
              <ul>
                <li><p>Main</p></li>
                <li><p>Chart Line</p></li>
                <li><p>Excel</p></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="col-10">
          <div class="table_content">
            <div class="top_content">
              <div class="row">
                <div class="col-12">
                  <p>HEAD</p>
                </div>
              </div>
            </div>


            <!-- Nút 1 -->
            <div id="dev1" class="bottom_content">
              <div class="line">
                <div class="row">
                  <div class="sensor_box col-4">
                    <div class="sensor_title">
                      
                      <h3>Sensor of Flame</h3>
                      <button id="reset_fire">Reset</button>
                      <i class="fa-solid fa-fire"></i>
                  
                   
                      
                    </div>
                    <div class="insite_box a">
                      <div class="status" id="statusBox1">
                        <p id="text_status1">Không có lửa</p>
                      </div>
                      <div class="show_time">
                        <p id="date_detected"></p>
                        <p id="time_detected"></p>
                        <p id="fire_duration"></p>
                      </div>
                    </div>
                  </div>
                  
                  <div class="sensor_box col-3">
                    <div class="sensor_title">
                      <h3>Sensor of Smoke</h3>
                      <i class="fa-solid fa-smog"></i>
                    </div>
                    <div class="insite_box">
                      <div class="status" id="statusBox3">
                        <p id="text_status3">Không có lửa</p>
                      </div>
                    </div>
                  </div>
    
                  <div class="sensor_box col-5">
                    <div class="sensor_title">
                      <h3>Setting sensors thresholds</h3>
                      <button id="push_thresholds">PUSH</button>
                      <i class="fa-solid fa-gear"></i>
                    </div>
                    <div class="insite_box">
                      <div class="row">
                        <div class="col-6">
                          <span>TempC Max:  </span>
                          <input type="number" id="tempCMax" min="0" max="60" placeholder="60">
                          <span>TempF Max:  </span>
                          <input type="number" id="tempFMax" min="0" max="60" placeholder="100">
                          <span>Humi Max:   </span>
                          <input type="number" id="humiMax" min="0" max="60" placeholder="100">
                          
                        </div>

                        <div class="col-6">
                          <span>TempF Min:</span>
                          <input type="number" id="tempCMin" min="0" max="60" placeholder="0">
                          <span>TempF Min:</span>
                          <input type="number" id="tempFMin" min="0" max="60" placeholder="0">
                          <span>Humi Min:</span>
                          <input type="number" id="humiMin" min="0" max="60" placeholder="0">
                        </div>
                      </div>
                      
                      
                    </div>
                  </div>
      
                  
                </div>
              </div>
              <div class="line2">
                <div class="row">
                  <div class="sensor_box col-6">
                    <div class="sensor_title">
                      <h3>Temperature Chart</h3>
                      <i class="fa-solid fa-temperature-three-quarters"></i>
                    </div>
                    <div class="insite_box">
                      <div class="status" id="statusBox_temp">
                        <canvas id="myChart1"></canvas>
                      </div>
                    </div>
                  </div>
                  <div class="sensor_box col-6">
                    <div class="sensor_title">
                      <h3>Humidity Chart</h3>
                      <i class="fa-solid fa-temperature-three-quarters"></i>
                    </div>
                    <div class="insite_box">
                      <div class="status" id="statusBox_temp">
                        <canvas id="myChart2"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>



            <!-- Nút 2 -->
            <div id="dev2" class="bottom_content">
              <div class="line">
                <div class="row">
                  <div class="sensor_box_web2_1 col-12">
                    <div class="sensor_title">
                      <h3>Temperature Chart</h3>
                      <i class="fa-solid fa-temperature-three-quarters"></i>
                    </div>
                    <div class="insite_box2">
                      <div class="status" id="statusBox_temp_web2">
                        <canvas id="myChart3" ></canvas>
                      </div>
                    </div>
                  </div>
                </div>
    
                <div class="row">
                  <div class="sensor_box_web2_2 col-12">
                    <div class="sensor_title">
                      <h3>Humidity Chart</h3>
                      <i class="fa-solid fa-temperature-three-quarters"></i>
                    </div>
                    <div class="insite_box2">
                      <div class="status" id="statusBox_humi_web2">
                        <canvas id="myChart4"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <!-- Nút 3 -->
            <div id="dev3" class="bottom_content">
              <div class="line">
                <div class="row">
                  <div class="sensor_box_web2_1 col-12">
                    <div class="sensor_title">
                      <h3>Table of all Sensor</h3>
                      <button id="infor_Table">Sensor Information Table</button>
                      <button id="alarm_Table">Alarm Table</button>

                      <i class="fa-solid fa-table"></i>
                    </div>
                    
                  </div>
                </div>
    
                <div class="row">
                  <div class="col-12">
                    <div class="insite_box2" id="table1">
                      <table id="myTable">
                        <tr>
                          <th rowspan="3">STT</th>
                          <th rowspan="3">Date</th>
                          <th rowspan="3" colspan="2">Name sensor</th>
                          <th colspan="7">Information</th>
                        </tr>
                        
                        <tr>
                          <th colspan="2">Min - Time</th>
                          <th colspan="2">Max - Time</th>
                          <th>AVG</th>
                          <th colspan="2">Max - Time</th>
                        </tr>
                        <tr>
                          
                          <th>Min</th>
                          <th>Time</th>
                          <th>Max</th>
                          <th>Time</th>
                          <th>Value</th>
                          <th>True/False</th>
                          <th>Time</th>
                      
                        </tr>

                      </table>
                    </div>

                    <!-- Bảng 2: Báo động -->
                    <div class="insite_box2" id="table2" style="display: none;">
                      <!-- Thêm nội dung bảng 2 ở đây -->
                      <table id="alarmTable">
                          <tr>
                              <th>STT</th>
                              <th>Sensors</th>
                              <th>True/False</th>
                              <th>Time</th>
                              <th>Alarm</th>
                          </tr>
                          <!-- Các hàng khác sẽ được thêm vào đây -->
                      </table>
                    </div>

                  </div>
                </div>
              </div>
            </div>




          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

















