<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Realtime Database</title>

    <link rel="icon" href="./assert/img/logo.png" type="icon">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://kit.fontawesome.com/9f25d43b0a.js" crossorigin="anonymous"></script>
    
    <title>Sensor Status</title>
    <link rel="stylesheet" href="./assert/reset.css">
    <link rel="stylesheet" href="./assert/style.css">
    <link rel="stylesheet" href="./assert/style2.css">
    

    <script type="module">
      let fireDetectedTime = null;
      let fireDetected = false;
      // let tempMin = 0;
      // let tempMax = 60;
      // let humiMin = 0;
      // let humiMax = 100;
      let chart1;
      let chart2;

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
      import { getDatabase, ref, set, remove, get, child, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
      // import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
  

      const firebaseConfig = {
          apiKey: "AIzaSyCTv0WFKuNafqszXmI40v_DIOVPkNqp-78",
          authDomain: "monitoring-sensor-4e47e.firebaseapp.com",
          databaseURL: "https://monitoring-sensor-4e47e-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "monitoring-sensor-4e47e",
          storageBucket: "monitoring-sensor-4e47e.appspot.com",
          messagingSenderId: "935434093765",
          appId: "1:935434093765:web:35353ee82daebe23e6dcac",
          measurementId: "G-B6MXC3TY4R"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const dbRef = ref(db); // Trỏ đến root để lấy tất cả các ngày
  
    let chartInstanceTemp = null; // Biến để lưu trữ đối tượng biểu đồ nhiệt độ
    let chartInstanceHumi = null; // Biến để lưu trữ đối tượng biểu đồ độ ẩm




    let fireData; // Biến toàn cục để lưu trữ dữ liệu về lửa





    function saveSensorValues() {
    fetch('r_read_values.php')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }
            // console.log(data);
            const today = new Date();
            const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
            // console.log("Fetched Data:", data);
            const updates = {};

            // Cập nhật dữ liệu cho các cảm biến nhiệt độ và độ ẩm
            const sensors = {
                'TemperatureC': data['b_sensor_TempC_values.txt'],
                'TemperatureF': data['b_sensor_TempF_values.txt'],
                'Humidity': data['c_sensor_Humi_values.txt']
            };

            // Lấy threshold hiện tại từ Firebase
            get(ref(db, `/Monitoring/${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`)).then((snapshot) => {
                const todayData = snapshot.exists() ? snapshot.val() : {};

                // Lấy dữ liệu của ngày hôm qua qua hàm mới
                fetchYesterdayData(today, (yesterdayData) => {
                  Object.keys(sensors).forEach(sensorType => {
                  const values = sensors[sensorType];
                  const todayThresholds = todayData[sensorType] || {};
                  const yesterdayThresholds = yesterdayData[sensorType] || {};

                  let highThreshold, lowThreshold;

                  // Thiết lập threshold tùy thuộc vào loại cảm biến
                  if (sensorType === 'TemperatureF') {
                      highThreshold = todayThresholds['HIGH_THRESHOLD'] || yesterdayThresholds['HIGH_THRESHOLD'] || 122; // Max cho độ F
                      lowThreshold = todayThresholds['LOW_THRESHOLD'] || yesterdayThresholds['LOW_THRESHOLD'] || 32;  // Min cho độ F
                  } else if (sensorType === 'Humidity') {
                      highThreshold = todayThresholds['HIGH_THRESHOLD'] || yesterdayThresholds['HIGH_THRESHOLD'] || 100; // Max cho độ ẩm
                      lowThreshold = todayThresholds['LOW_THRESHOLD'] || yesterdayThresholds['LOW_THRESHOLD'] || 0;    // Min cho độ ẩm
                  } else if (sensorType === 'Fire') {
                      highThreshold = 60;  // Max cố định cho lửa là 60
                      lowThreshold = 0;    // Min cố định cho lửa là 0
                  } else {
                      // Mặc định cho các loại cảm biến khác (nếu có)
                      highThreshold = todayThresholds['HIGH_THRESHOLD'] || yesterdayThresholds['HIGH_THRESHOLD'] || 60; // Default max
                      lowThreshold = todayThresholds['LOW_THRESHOLD'] || yesterdayThresholds['LOW_THRESHOLD'] || 0;    // Default min
                  }
                  // console.log(values.time);
                  updates[sensorType] = {
                      'MIN': `${values.min || 'N/A'}`,
                      'MAX': `${values.max || 'N/A'}`,
                      'AVG': `${values.average || 'N/A'}`,
                      'MIN_TIME': `${values.min_time || 'N/A'}`,
                      'MAX_TIME': `${values.max_time || 'N/A'}`,
                      'HIGH_THRESHOLD': highThreshold,
                      'LOW_THRESHOLD': lowThreshold
                  };
              });
                    // Dữ liệu của cảm biến lửa
                    const fireData = data['a_sensor_Fire_values.txt'];
                    updates['Fire'] = {
                        isFire: fireData?.isFire === '1',
                        duration: fireData?.duration || '00:00:00',
                        start_time: fireData?.start_time || 'N/A',
                        end_time: fireData?.end_time || 'N/A',
                        date_detected: fireData?.date_detected || 'N/A',
                        AVG: fireData?.avg_temp_during_fire|| 'N/A',
                        MIN: fireData?.temp_min_in_fire|| 'N/A',
                        MAX: fireData?.temp_max_in_fire|| 'N/A',
                        TIME_MIN: fireData?.time_min_in_fire|| '00:00:00',
                        TIME_MAX: fireData?.time_max_in_fire|| '00:00:00',


                    };

                    const validUpdates = {};
                    for (const [key, value] of Object.entries(updates)) {
                        const sanitizedKey = key.replace(/[/\[\].#$]/g, '_');
                        validUpdates[sanitizedKey] = value;
                    }

                    set(ref(db, `/Monitoring/${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`), validUpdates)
                        .then(() => {
                            // console.log('Sensor values saved successfully after reset!');
                        })
                        .catch((error) => {
                            console.error('Error saving sensor values after reset: ', error);
                        });
                });

            }).catch((error) => {
                console.error('Error fetching today\'s thresholds:', error);
            });
        })
        .catch((error) => {
            console.error('Error fetching sensor values:', error);
        });
}

function fetchYesterdayData(today, callback) {
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    const yesterdayKey = `${yesterday.getFullYear()}-${yesterday.getMonth() + 1}-${yesterday.getDate()}`;

    get(ref(db, `/Monitoring/${yesterday.getFullYear()}/${yesterday.getMonth() + 1}/${yesterday.getDate()}`))
        .then((snapshot) => {
            const yesterdayData = snapshot.exists() ? snapshot.val() : {};
            callback(yesterdayData);
        })
        .catch((error) => {
            console.error('Error fetching yesterday\'s thresholds:', error);
            callback({});
        });
}



function updateFireLogAndFetch(data) {
    // Đầu tiên, đọc dữ liệu từ Firebase trước khi thực hiện thao tác xóa tệp.
    

    const today = new Date();
    const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const day = today.getDate();
    
    const date = data['Monitoring'][year]?.[month]?.[day];
    if (!date || !date['Fire']) {
        console.error(`No fire data for ${year}-${month}-${day}`);
        return;
    }

    const is_fire = date['Fire']?.isFire || 'false';
    const start_time = date['Fire']?.start_time || '00:00:00';
    const end_time = date['Fire']?.end_time || '00:00:00';
    const temp_AVG = date['Fire']?.AVG || 'N/A';
    const temp_Max = date['Fire']?.MAX || 'N/A';
    const temp_Min = date['Fire']?.MIN || 'N/A';
    const temp_time_Max = date['Fire']?.TIME_MIN || 'N/A';
    const temp_time_Min = date['Fire']?.TIME_MAX || 'N/A';

    const fireLogRef = ref(db, `/Monitoring/Fire_Log/${dateKey}/${start_time}`);

    if (is_fire !== 'false') {
        // Đọc và cập nhật log từ Firebase
        get(fireLogRef).then((snapshot) => {
            if (!snapshot.exists()) {
                // Nếu chưa tồn tại log, tạo mới
                console.log(fireLogRef);
                return set(fireLogRef, {
                    start_time: start_time,
                    end_time: end_time,
                    isFire: true,
                    AVG: temp_AVG,
                    MAX: temp_Max,
                    MIN: temp_Min,
                    TIME_MAX: temp_time_Max,
                    TIME_MIN: temp_time_Min
                });
            } else {
                // Cập nhật log nếu đã tồn tại
                return set(fireLogRef, {
                    start_time: start_time,
                    end_time: end_time,
                    isFire: true,
                    AVG: temp_AVG,
                    MAX: temp_Max,
                    MIN: temp_Min,
                    TIME_MAX: temp_time_Max,
                    TIME_MIN: temp_time_Min
                });
            }
        }).then(() => {
            console.log('Fire log saved/updated successfully in Firebase!');

            // Sau khi hoàn tất cập nhật log, thực hiện xóa hoặc reset nội dung file txt
            fetchFireData(); 
        }).catch((error) => {
            console.error('Error handling fire log in Firebase:', error);
        });
    }
}

function fetchFireData() {
    fetch('r_check_fire.php') // Đảm bảo URL đúng với nơi lưu PHP script
    .then(response => response.json()) // Chuyển đổi kết quả fetch thành JSON
    .then(data => {
            // Nếu không có lỗi, lấy start_time và end_time từ phản hồi
            const startTime = data.start_time;
            const endTime = data.end_time;
            const pythonOutput = data.python_output;

              // console.log('Fire Event Detected:');
              // console.log('Start Time:', startTime);
              // console.log('End Time:', endTime);
              // console.log('Python Script Output:', pythonOutput);
        
    })
    .catch(error => {
        console.error('Fetch Error:', error);
    });
}



async function save31day(data) {
    let totalDays = 0;
    let allDates = [];
    let monthMap = {};
    let yearMap = {};

    // Xác định ngày từ phần 'Monitoring'
    if (data['Monitoring']) {
        for (const yearKey in data['Monitoring']) {
            if (data['Monitoring'].hasOwnProperty(yearKey) && yearKey !== 'Fire_Log') {
                const yearData = data['Monitoring'][yearKey];
                yearMap[yearKey] = {};

                for (const monthKey in yearData) {
                    if (yearData.hasOwnProperty(monthKey)) {
                        const monthData = yearData[monthKey];
                        monthMap[`${yearKey}-${monthKey}`] = false;
                        yearMap[yearKey][monthKey] = false;

                        for (const dayKey in monthData) {
                            if (monthData.hasOwnProperty(dayKey)) {
                                allDates.push(`${yearKey}-${String(monthKey).padStart(2, '0')}-${String(dayKey).padStart(2, '0')}`);
                                monthMap[`${yearKey}-${monthKey}`] = true;
                                yearMap[yearKey][monthKey] = true;
                                totalDays++;
                            }
                        }
                    }
                }
            }
        }

        // Xóa dữ liệu ngày cũ nếu tổng số ngày lớn hơn 9
        if (allDates.length > 0) {
            allDates.sort((a, b) => new Date(a) - new Date(b));

            while (totalDays > 9 && allDates.length > 0) {
                const smallestDate = allDates[0];
                const [year, month, day] = smallestDate.split('-');
                const pathToDelete = `/Monitoring/${year}/${parseInt(month)}/${parseInt(day)}`;
                const dbRef = ref(db, pathToDelete);

                try {
                    await remove(dbRef); // Sử dụng await để đợi xóa xong
                    console.log("Xóa thành công ngày nhỏ nhất:", smallestDate);
                    allDates.shift();
                    totalDays--;
                } catch (error) {
                    console.error("Lỗi khi xóa ngày:", error);
                }
            }

            // Xóa dữ liệu tháng nếu không còn ngày nào
            for (const monthKey in monthMap) {
                if (monthMap.hasOwnProperty(monthKey) && !monthMap[monthKey]) {
                    const [year, month] = monthKey.split('-');
                    const pathToDelete = `/Monitoring/${year}/${parseInt(month)}`;
                    const dbRef = ref(db, pathToDelete);

                    try {
                        await remove(dbRef);
                        console.log("Xóa thành công tháng:", monthKey);
                    } catch (error) {
                        console.error("Lỗi khi xóa tháng:", error);
                    }
                }
            }

            // Xóa dữ liệu năm nếu không còn tháng nào
            for (const yearKey in yearMap) {
                if (yearMap.hasOwnProperty(yearKey)) {
                    const months = yearMap[yearKey];
                    const hasMonths = Object.keys(months).some(month => months[month]);

                    if (!hasMonths) {
                        const pathToDelete = `/Monitoring/${yearKey}`;
                        const dbRef = ref(db, pathToDelete);

                        try {
                            await remove(dbRef);
                            console.log("Xóa thành công năm:", yearKey);
                        } catch (error) {
                            console.error("Lỗi khi xóa năm:", error);
                        }
                    }
                }
            }
        } else {
            console.log("Không có ngày nào trong dữ liệu.");
        }
    } else {
        console.error('Data không tồn tại!');
    }
}

// // const reset_fire = document.getElementById('reset_fire');
// // reset_fire.addEventListener('click', function() {
// //     // Hàm để thực hiện các fetch
// //     function fetchData() {
// //         // Gửi yêu cầu đến r_read_values.php trước
// //         return fetch('r_read_values.php')
// //             .then(response => response.json())
// //             .then(sensorData => {
// //                 if (sensorData.error) {
// //                     throw new Error('Error fetching sensor data: ' + sensorData.error);
// //                 }
// //                 return sensorData;
// //             });
// //     }

// //     Hàm để reset dữ liệu
// //     function resetData() {
// //         // Gửi yêu cầu đến r_reset.php
// //         return fetch('r_reset.php')
// //             .then(response => response.text())
// //             .then(resetResponse => {
// //                 if (!resetResponse.includes('Reset successful')) {
// //                     throw new Error('Error resetting data: ' + resetResponse);
// //                 }
// //                 return resetResponse;
// //             });
// //     }

// //     Gọi hàm và xử lý kết quả
// //     fetchData()
// //         .then(sensorData => {
// //             // Xử lý dữ liệu từ r_read_values.php
// //             alert('Fire data has been fetched.');
            
// //             const fireData = sensorData['a_sensor_Fire_values.txt'];
// //             console.log(fireData);
// //             const today = new Date();
// //             const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
// //             const start_time = fireData?.time_detected || '00:00:00';
// //             const end_time = fireData?.current || '00:00:00';
// //             const temp_AVG = fireData?.avg_temp_during_fire || 'N/A';
// //             const temp_Max = fireData?.temp_max_in_fire || 'N/A';
// //             const temp_Min = fireData?.temp_min_in_fire || 'N/A';
// //             const temp_time_Max = fireData?.time_min_in_fire || 'N/A';
// //             const temp_time_Min = fireData?.time_max_in_fire || 'N/A';

// //             // Lưu log trực tiếp lên Firebase
// //             const fireLogRef = ref(db, `/Fire_Log/${dateKey}/${start_time}`);
// //             return get(fireLogRef).then((snapshot) => {
// //                 if (!snapshot.exists()) {
// //                     return set(fireLogRef, {
// //                         start_time: start_time,
// //                         end_time: end_time,
// //                         isFire: true,
// //                         AVG: temp_AVG,
// //                         MAX: temp_Max,
// //                         MIN: temp_Min,
// //                         TIME_MAX: temp_time_Max,
// //                         TIME_MIN: temp_time_Min
// //                     }).then(() => {
// //                         console.log('Fire log saved successfully to Firebase!');
// //                     }).catch((error) => {
// //                         console.error('Error saving fire log to Firebase:', error);
// //                     });
// //                 } else {
// //                     console.log('Log with this start time already exists.');
// //                 }
// //             });
// //         })
// //         .then(() => {
// //             // Sau khi cập nhật log, reset dữ liệu
// //             // return resetData();
// //         })
// //         .then(resetResponse => {
// //             alert('Fire data has been reset.');
// //             console.log('Reset response:', resetResponse);
// //         })
// //         .catch(error => {
// //             console.error('Error:', error);
// //         });
// // });





document.getElementById('push_thresholds').addEventListener('click', function() {
    // Thu thập các giá trị từ các input
    const tempCMax = document.getElementById('tempCMax')?.value;
    const tempCMin = document.getElementById('tempCMin')?.value;

    const tempFMax = document.getElementById('tempFMax')?.value;
    const tempFMin = document.getElementById('tempFMin')?.value;

    const humiMax = document.getElementById('humiMax')?.value;
    const humiMin = document.getElementById('humiMin')?.value;

    if (!tempCMax || !tempCMin || !tempFMax || !tempFMin || !humiMax || !humiMin) {
        alert('Please fill in all 6 values before pushing the data.');
        return;
    }

    // console.log('Các giá trị thresholds:', tempCMax, tempFMax, humiMax, tempCMin, tempFMin, humiMin);


    const today = new Date();
    let dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
    dateKey = dateKey.replace(/[\.\#\$\[\]]/g, '_'); 
    const thresholdsC = {
        HIGH_THRESHOLD: tempCMax,
        LOW_THRESHOLD: tempCMin
    };
    
    const thresholdsF = {
        HIGH_THRESHOLD: tempFMax,
        LOW_THRESHOLD: tempFMin
    };

    const thresholdsH = {
        HIGH_THRESHOLD: humiMax,
        LOW_THRESHOLD: humiMin
    };

   // Đẩy dữ liệu lên Firebase
   set(ref(db, `/Monitoring/${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}/TemperatureC`), thresholdsC)
        .then(() => {
            console.log('TemperatureC thresholds updated successfully!');
            document.getElementById('tempCMax').value = "";
            document.getElementById('tempCMin').value = "";
            window.location.reload(); // Reload lại trang sau khi cập nhật thành công
        })
        .catch(error => console.error('Error updating TemperatureC thresholds: ', error));

    set(ref(db, `/Monitoring/${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}/TemperatureF`), thresholdsF)
        .then(() => {
            console.log('TemperatureF thresholds updated successfully!');
            document.getElementById('tempFMax').value = "";
            document.getElementById('tempFMin').value = "";
            window.location.reload(); // Reload lại trang sau khi cập nhật thành công
        })
        .catch(error => console.error('Error updating TemperatureF thresholds: ', error));

    set(ref(db, `/Monitoring/${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}/Humidity`), thresholdsH)
        .then(() => {
            console.log('Humidity thresholds updated successfully!');
            document.getElementById('humiMax').value = "";
            document.getElementById('humiMin').value = "";
            window.location.reload(); // Reload lại trang sau khi cập nhật thành công
        })
        .catch(error => console.error('Error updating Humidity thresholds: ', error));
});









function loadThresholds_placeholder() {
    // console.log("Function loadThresholds_placeholder called");  // Check if function is called

    const today = new Date();
    const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;

    const dbRef = ref(db, `/Monitoring/${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`);
    get(dbRef).then((snapshot) => {
        // console.log("Fetched data from Firebase");  // Check if data fetching is initiated

        if (snapshot.exists()) {
            const data = snapshot.val();
            // console.log("Data exists in Firebase:", data.TemperatureC.HIGH_THRESHOLD);  // Log the entire data object

            // Set placeholders with values from Firebase
            document.getElementById('tempCMax').placeholder = data.TemperatureC?.HIGH_THRESHOLD;
            document.getElementById('tempCMin').placeholder = data.TemperatureC?.LOW_THRESHOLD ;

            document.getElementById('tempFMax').placeholder = data.TemperatureF?.HIGH_THRESHOLD;
            document.getElementById('tempFMin').placeholder = data.TemperatureF?.LOW_THRESHOLD ;

            document.getElementById('humiMax').placeholder = data.Humidity?.HIGH_THRESHOLD;
            document.getElementById('humiMin').placeholder = data.Humidity?.LOW_THRESHOLD;
        } else {
            console.log("No data available for today.");  // Log when no data is found
        }
    }).catch((error) => {
        console.error('Error fetching data:', error);  // Log errors
    });
}


// // document.addEventListener('DOMContentLoaded', () => {
// //     document.getElementById('on_Fire').addEventListener('click', () => {
// //       toggleFireStatus1(); // Thay đổi trạng thái của cảm biến
// //       fetchTurnOnFire();  // Gửi yêu cầu đến turn_on_Fire.php
// //     });

// //     document.getElementById('off_Fire').addEventListener('click', () => {
// //       toggleFireStatus2();  
// //       fetchTurnOffFire();  // Gửi yêu cầu đến turn_off_Fire.php
        
// //     });
// // });

// // function toggleFireStatus1() {
// //     const statusFire = document.getElementById('status_Fire');

// //     // Thay đổi nội dung của <p> dựa trên nội dung hiện tại
// //     if (statusFire.textContent === 'off') {
// //         statusFire.textContent = 'on';
// //         statusFire.style.backgroundColor = 'green'; // Thay đổi backgroundColor qua style
// //     } 
// // }
// // function toggleFireStatus2() {
// //     const statusFire = document.getElementById('status_Fire');

// //     // Thay đổi nội dung của <p> dựa trên nội dung hiện tại
// //     if (statusFire.textContent === 'on') {
// //         statusFire.textContent = 'off';
// //         statusFire.style.backgroundColor = 'red'; // Thay đổi backgroundColor qua style
// //     } 
// // }

// // function fetchTurnOnFire() {
// //     fetch('turn_on_Fire.php')
// //         .then(response => response.text())
// //         .then(data => {
// //             console.log('Server response:', data);
// //         })
// //         .catch(error => {
// //             console.error('Error:', error);
// //         });
// // }

// // function fetchTurnOffFire() {
// //     fetch('turn_off_Fire.php')
// //         .then(response => response.text())
// //         .then(data => {
// //             console.log('Server response:', data);
// //         })
// //         .catch(error => {
// //             console.error('Error:', error);
// //         });
// // }



// // // Hàm để kiểm tra và xóa tệp tin nếu thời gian hiện tại đã đạt đến 14:29:00
// // function checkAndDeleteFiles() {
// //     // Lấy thời gian hiện tại
// //     const now = new Date();
// //     const currentTime = now.toTimeString().substring(0, 8); // Lấy thời gian hiện tại theo định dạng HH:MM

// //     // Thời gian cụ thể để thực hiện xóa
// //     const targetTime = '14:33:20';

// //     // So sánh thời gian hiện tại với thời gian mục tiêu
// //     if (currentTime === targetTime) {
// //         // Gọi file PHP để xóa tệp tin
// //         fetch('/sensor_values/r_delete_txt.php')
// //             .then(response => response.json())
// //             .then(data => {
// //                 if (data.error) {
// //                     console.error('Error:', data.error);
// //                 } else {
// //                     console.log('Files deleted successfully!');
// //                 }
// //             })
// //             .catch((error) => {
// //                 console.error('Error deleting files:', error);
// //             });
// //     }
// // }

// // // Thực thi hàm kiểm tra ngay khi trang được tải
// // window.onload = function() {
// //     checkAndDeleteFiles();
// //     // Cài đặt một interval để kiểm tra mỗi giây
// //     setInterval(checkAndDeleteFiles, 1000); // 1000 milliseconds = 1 second
// // };





























let fireDuration = 0; // Biến toàn cục để lưu thời gian cháy
let fireInterval = null; // Biến để lưu interval

function updateBox(data) {
    // Lấy ngày hiện tại
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1; // Tháng từ 1 đến 12
    const day = today.getDate();

    // Lấy phần tử bảng
    const statusBox = document.getElementById('statusBox1');
    const text_noti_sensor_fire = document.getElementById('text_status1');
    const date_detected = document.getElementById('date_detected');
    const time_detected = document.getElementById('time_detected');
    const fire_duration = document.getElementById('fire_duration');

    // Hàm chuyển đổi giây thành định dạng 00:00:00
    function secondsToTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    // console.log(data['Monitoring'] );
    // Kiểm tra nếu dữ liệu có ngày hiện tại và thuộc tính Fire
    if ( data &&  data['Monitoring'][year] &&  data['Monitoring'][year][month] &&  data['Monitoring'][year][month][day] &&  data['Monitoring'][year][month][day].Fire) {
        const fireData =  data['Monitoring'][year][month][day]['Fire'];

        // Kiểm tra trạng thái lửa
        if (fireData.isFire) {
            // Khi có lửa, bắt đầu tăng thời gian cháy (chỉ khi chưa có interval)
            if (!fireInterval) {
                statusBox.style.backgroundColor = 'red';
                text_noti_sensor_fire.textContent = 'Có lửa';
                date_detected.textContent = `Date detected: ${fireData.date_detected}`;
                time_detected.textContent = `Time detected: ${fireData.start_time}`;

                // Bắt đầu interval nếu chưa có
                fireInterval = setInterval(() => {
                    fireDuration++; // Tăng giá trị fireDuration mỗi giây
                    fire_duration.textContent = `Fire duration: ${secondsToTime(fireDuration)}`; // Hiển thị thời gian cháy
                }, 1000);
            }
        } else {
            // Khi không có lửa, dừng đếm thời gian và reset giá trị
            fireDuration = 0;

            statusBox.style.backgroundColor = 'green';
            text_noti_sensor_fire.textContent = 'Không có lửa';
            date_detected.textContent = `Date detected: `;
            time_detected.textContent = 'Time detected:';
            fire_duration.textContent = 'Fire duration: ';

            // Dừng interval và reset fireInterval
            if (fireInterval) {
                clearInterval(fireInterval);
                fireInterval = null;
            }
        }
    }
}










function updateChart(data) {
  const today = new Date();
  const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
  const year = today.getFullYear();
  const month = today.getMonth() + 1;
  const day = today.getDate();

  // Kiểm tra dữ liệu có phải là đối tượng không
  if (typeof  data['Monitoring'] !== 'object' ||  data['Monitoring'] === null) {
    console.error('Dữ liệu không hợp lệ:',  data['Monitoring']);
    return;
  }
 
  const labels = [];
  const tempMinValues = [];
  const tempMaxValues = [];
  const tempAvgValues = [];

  const humiMinValues = [];
  const humiMaxValues = [];
  const humiAvgValues = [];
  // console.log(data['Monitoring']);
  // console.log(data['Monitoring']);
  // Lặp qua các năm trong dữ liệu
  for (const year in  data['Monitoring']) {
    if (data['Monitoring'].hasOwnProperty(year) && year !== 'Fire_Log') {
      const yearData =  data['Monitoring'][year];
      console.log(yearData);
      // Lặp qua các tháng trong năm
      for (const month in yearData) {
        if (yearData.hasOwnProperty(month)) {
          const monthData = yearData[month];
        
          // Lặp qua các ngày trong tháng
          for (const day in monthData) {
            if (monthData.hasOwnProperty(day)) {
              const dayData = monthData[day];

              const dayData_Temp = dayData['TemperatureC']; // Lấy dữ liệu của loại cảm biến 'Temperature'
              const dayData_Humi = dayData['Humidity']; // Lấy dữ liệu của loại cảm biến 'Humidity'

              labels.push(`${year}-${month}-${day}`); // Thêm ngày vào danh sách nhãn

              if (dayData_Temp) {
                tempMinValues.push(dayData_Temp.MIN || 0); // Thêm giá trị MIN vào danh sách dữ liệu
                tempMaxValues.push(dayData_Temp.MAX || 0); // Thêm giá trị MAX vào danh sách dữ liệu
                tempAvgValues.push(dayData_Temp.AVG || 0); // Thêm giá trị AVG vào danh sách dữ liệu
              }

              if (dayData_Humi) {
                humiMinValues.push(dayData_Humi.MIN || 0); // Thêm giá trị MIN vào danh sách dữ liệu
                humiMaxValues.push(dayData_Humi.MAX || 0); // Thêm giá trị MAX vào danh sách dữ liệu
                humiAvgValues.push(dayData_Humi.AVG || 0); // Thêm giá trị AVG vào danh sách dữ liệu
              }
            }
          }
        }
      }
    }
  }

  const ctx1 = document.getElementById('myChart3').getContext('2d');
  const ctx2 = document.getElementById('myChart4').getContext('2d');

  if (chartInstanceTemp) {
    chartInstanceTemp.destroy(); // Hủy biểu đồ cũ nếu tồn tại
  }
  if (chartInstanceHumi) {
    chartInstanceHumi.destroy(); // Hủy biểu đồ cũ nếu tồn tại
  }

  const tempData = {
    labels: labels.reverse(),
    datasets: [
      {
        label: 'Temp AVG',
        data: tempAvgValues.reverse(),
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderColor: 'rgb(255, 99, 132)',
        borderWidth: 1,
      },
      {
        label: 'Temp Max',
        data: tempMaxValues.reverse(),
        backgroundColor: 'rgba(255, 159, 64, 0.2)',
        borderColor: 'rgb(255, 159, 64)',
        borderWidth: 1,
      },
      {
        label: 'Temp MIN',
        data: tempMinValues.reverse(),
        backgroundColor: 'rgba(255, 205, 86, 0.2)',
        borderColor: 'rgb(255, 205, 86)',
        borderWidth: 1,
      }
    ]
  };

  const humiData = {
    labels: labels,
    datasets: [
      {
        label: 'Humi AVG',
        data: humiAvgValues.reverse(),
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderColor: 'rgb(54, 162, 235)',
        borderWidth: 1,
      },
      {
        label: 'Humi Max',
        data: humiMaxValues.reverse(),
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        borderColor: 'rgb(75, 192, 192)',
        borderWidth: 1,
      },
      {
        label: 'Humi MIN',
        data: humiMinValues.reverse(),
        backgroundColor: 'rgba(153, 102, 255, 0.2)',
        borderColor: 'rgb(153, 102, 255)',
        borderWidth: 1,
      }
    ]
  };

  const config_Temp = {
    type: 'bar',
    data: tempData,
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: 'Dữ liệu cảm biến Nhiệt độ'
        }
      }
    },
  };

  const config_Humi = {
    type: 'bar',
    data: humiData,
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: 'Dữ liệu cảm biến Độ ẩm'
        }
      }
    },
  };
//   console.log('Labels:', labels);
// console.log('Temp Min Values:', tempMinValues);
// console.log('Temp Max Values:', tempMaxValues);
// console.log('Temp Avg Values:', tempAvgValues);
// console.log('Humi Min Values:', humiMinValues);
// console.log('Humi Max Values:', humiMaxValues);
// console.log('Humi Avg Values:', humiAvgValues);

  chartInstanceTemp = new Chart(ctx1, config_Temp); // Khởi tạo biểu đồ mới cho nhiệt độ
  chartInstanceHumi = new Chart(ctx2, config_Humi); // Khởi tạo biểu đồ mới cho độ ẩm
}

    let chartTemp, chartHumi;
    let data1, data2;
    
    function updateChart_Temp_Humi() {
    const today = new Date();
    const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
    const dbRef = ref(db, `/Monitoring/${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`);

    get(dbRef).then((snapshot) => {
        const data = snapshot.val() || {};
        // console.log('Data received for thresholds:', data); // Kiểm tra dữ liệu đầu vào

        // Tạo nhãn cho Biểu đồ
        const labels = Array(13).fill('');

        // Cập nhật dữ liệu biểu đồ Nhiệt độ
        data1 = {
            labels: labels,
            datasets: [{
                label: 'Biểu đồ nhiệt độ (°C)',
                data: Array(labels.length).fill(0), // Bạn cần cập nhật giá trị này với dữ liệu thực tế
                fill: false,
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.1,
                borderWidth: 2,
                yAxisID: 'y-axis-1'
            }, {
                label: 'Biểu đồ nhiệt độ (°F)',
                data: Array(labels.length).fill(0), // Bạn cần cập nhật giá trị này với dữ liệu thực tế
                fill: false,
                borderColor: 'rgb(54, 162, 235)',
                tension: 0.1,
                borderWidth: 2,
                yAxisID: 'y-axis-2'
            }]
        };

        // Cập nhật dữ liệu biểu đồ Độ ẩm
        data2 = {
            labels: labels,
            datasets: [{
                label: 'Biểu đồ độ ẩm (%)',
                data: Array(labels.length).fill(0), // Bạn cần cập nhật giá trị này với dữ liệu thực tế
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                yAxisID: 'y-axis-1'
            }]
        };

        // Cấu hình cho Biểu đồ Nhiệt độ
        const config1 = {
            type: 'line',
            data: data1,
            options: {
                scales: {
                    'y-axis-1': {
                        type: 'linear',
                        position: 'left',
                        min: data['TemperatureC']?.LOW_THRESHOLD || 0,
                        max: data['TemperatureC']?.HIGH_THRESHOLD || 50,
                        ticks: {
                            callback: function(value) {
                                return value + '°C';
                            },
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Nhiệt độ (°C)'
                        }
                    },
                    'y-axis-2': {
                        type: 'linear',
                        position: 'right',
                        min: data['TemperatureF']?.LOW_THRESHOLD || 32,
                        max: data['TemperatureF']?.HIGH_THRESHOLD || 122,
                        ticks: {
                            callback: function(value) {
                                return value + '°F';
                            },
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Nhiệt độ (°F)'
                        }
                    }
                },
                plugins: {
                    datalabels: {
                        display: true,
                        color: 'black',
                        align: 'top',
                        formatter: function(value) {
                            return value;
                        }
                    }
                }
            }
        };

        // Cấu hình cho Biểu đồ Độ ẩm
        const config2 = {
            type: 'line',
            data: data2,
            options: {
                scales: {
                    'y-axis-1': {
                        type: 'linear',
                        position: 'left',
                        min: data['Humidity']?.LOW_THRESHOLD || 0,
                        max: data['Humidity']?.HIGH_THRESHOLD || 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        scaleLabel: {
                            display: true,
                            labelString: 'Độ ẩm (%)'
                        }
                    }
                },
                plugins: {
                    datalabels: {
                        display: true,
                        color: 'black',
                        align: 'top',
                        formatter: function(value) {
                            return value;
                        }
                    }
                }
            }
        };

        const ctx1 = document.getElementById('myChart1').getContext('2d');
        const ctx2 = document.getElementById('myChart2').getContext('2d');

        if (chartTemp) chartTemp.destroy(); // Hủy biểu đồ cũ nếu có
        chartTemp = new Chart(ctx1, config1);

        if (chartHumi) chartHumi.destroy(); // Hủy biểu đồ cũ nếu có
        chartHumi = new Chart(ctx2, config2);

    }).catch(error => {
        console.error('Error fetching data:', error);
    });
}



function updateCharts() {
    const now = new Date();
    const formattedTime = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;

    fetch('b_temp_humi_status.php')
        .then(response => response.json())
        .then(data => {
            let tempCValue = parseFloat(data['b_sensor_TempC_values.txt']) || 0;
            let tempFValue = parseFloat(data['b_sensor_TempF_values.txt']) || 0;
            let humidityValue = parseFloat(data['c_sensor_Humi_values.txt']) || 0;

            // Giới hạn giá trị Nhiệt độ C theo ngưỡng
            const tempCLowThreshold = chartTemp.options.scales['y-axis-1'].min;
            const tempCHighThreshold = chartTemp.options.scales['y-axis-1'].max;
            if (tempCValue <= tempCLowThreshold) tempCValue = tempCLowThreshold;
            if (tempCValue > tempCHighThreshold) tempCValue = tempCHighThreshold;

            // Giới hạn giá trị Nhiệt độ F theo ngưỡng
            const tempFLowThreshold = chartTemp.options.scales['y-axis-2'].min;
            const tempFHighThreshold = chartTemp.options.scales['y-axis-2'].max;
            if (tempFValue < tempFLowThreshold) tempFValue = tempFLowThreshold;
            if (tempFValue > tempFHighThreshold) tempFValue = tempFHighThreshold;

            // Giới hạn giá trị Độ ẩm theo ngưỡng
            const humidityLowThreshold = chartHumi.options.scales['y-axis-1'].min;
            const humidityHighThreshold = chartHumi.options.scales['y-axis-1'].max;
            if (humidityValue < humidityLowThreshold) humidityValue = humidityLowThreshold;
            if (humidityValue > humidityHighThreshold) humidityValue = humidityHighThreshold;

            // Cập nhật Biểu đồ Nhiệt độ C
            if (data1) {
                data1.datasets[0].data.shift();
                data1.datasets[0].data.push(tempCValue);
                data1.labels.shift();
                data1.labels.push(formattedTime);
            }

            // Cập nhật Biểu đồ Nhiệt độ F
            if (data1) {
                data1.datasets[1].data.shift();
                data1.datasets[1].data.push(tempFValue);
            }

            chartTemp.update();

            // Cập nhật Biểu đồ Độ ẩm
            if (data2) {
                data2.datasets[0].data.shift();
                data2.datasets[0].data.push(humidityValue);
                data2.labels.shift();
                data2.labels.push(formattedTime);
            }

            chartHumi.update();

        }).catch(error => console.error('Error:', error));
}



let chartData = null;  // Biến toàn cục để lưu dữ liệu Firebase

function fetchDataFromFirebase() {
  onValue(dbRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      chartData = data;
      updateBox(data);
      updateTable(data);  
      updateTable2(data); 
      updateFireLogAndFetch(data);
      save31day(data);
    } else {
      console.error('Không có dữ liệu từ Firebase');
    }
  }, (error) => {
    console.error('Lỗi khi lấy dữ liệu từ Firebase:', error);
  });
}

window.onload = function() {
  fetchDataFromFirebase();

  // Set intervals for updating various components
  setInterval(saveSensorValues, 2000);          // Update Database
  setInterval(fetchDataFromFirebase, 1000);     // Update charts from Firebase every 1 second
  updateChart_Temp_Humi();                      // Call updateChart_Temp_Humi
  setInterval(updateBox, 1000);                 // Update Fire status every 1 second
  setInterval(updateCharts, 1000);              // Update charts with sensor data every 1 second

  // Cập nhật biểu đồ lần đầu tiên sau 1 giây
  setTimeout(() => {
    if (chartData) {
      updateChart(chartData);  // Gọi updateChart với dữ liệu từ Firebase đã lưu
    }

    // Sau lần cập nhật đầu tiên, tiếp tục cập nhật mỗi 5 giây
    setInterval(() => {
      if (chartData) {
        updateChart(chartData);  // Gọi updateChart mỗi 5 giây
      }
    }, 5000);  // 5 giây

  }, 1000);  // 1 giây cho lần cập nhật đầu tiên

  // Placeholder function, if needed
  loadThresholds_placeholder();
};




    function showDiv(divNumber) {
        // Ẩn tất cả các div
        document.querySelectorAll('.bottom_content').forEach(div => {
            div.style.display = 'none';
        });

        // Hiển thị div tương ứng với số nút bấm
        document.getElementById(`dev${divNumber}`).style.display = 'block';
      }

      // Gán sự kiện onclick cho các nút bấm
      document.querySelectorAll('.menu_left li').forEach((item, index) => {
          item.addEventListener('click', () => showDiv(index + 1));
      });

      document.querySelectorAll('.menu_left li').forEach((item, index) => {
        item.addEventListener('click', () => {
            // Reset background color and border for all items
            document.querySelectorAll('.menu_left li').forEach((li) => {
                li.style.backgroundColor = 'black'; // Màu nền mặc định
                li.style.border = '1px solid white'; // Viền mặc định
            });

            // Reset color and border for all paragraphs
            document.querySelectorAll('.menu_left li p').forEach((paragraph) => {
                paragraph.style.color = 'white'; // Màu chữ mặc định
                paragraph.style.border = '1px solid white'; // Viền mặc định
            });

            // Set background color and border for the clicked item
            item.style.backgroundColor = 'white';
            item.style.border = '1px solid black';

            // Set color and border for the paragraph within the clicked item
            let paragraph = item.querySelector('p');
            if (paragraph) {
                paragraph.style.color = 'black';
                paragraph.style.border = '1px solid black';
            }

            // Call the showDiv function with the appropriate index
            showDiv(index + 1);
        });
    });


      showDiv(1);

    // Gán sự kiện onclick cho các nút bấm
    document.getElementById('infor_Table').addEventListener('click', () => {
        document.getElementById('table1').style.display = 'block';
        document.getElementById('table2').style.display = 'none';
       
    });

    document.getElementById('alarm_Table').addEventListener('click', () => {
        document.getElementById('table1').style.display = 'none';
        document.getElementById('table2').style.display = 'block';
    });

    function updateTable(data) {
    // Xác định năm cần hiển thị dữ liệu
    const years = Object.keys(data['Monitoring']).reverse(); // Lấy danh sách các năm từ dữ liệu và đảo ngược

    // Tìm phần tử bảng
    const table1 = document.getElementById("myTable");

    // Xoá các hàng cũ (nếu cần)
    table1.innerHTML = `
        <tr>
            <th rowspan="3">No.</th>
            <th rowspan="3">Date</th>
            <th rowspan="3" colspan="2">Sensor Type</th>
            <th colspan="5">Specification</th>
        </tr>
        <tr>
            <th colspan="2">Min - Time</th>
            <th colspan="2">Max - Time</th>
            <th>AVG</th>
        </tr>
        <tr>
            <th>Min</th>
            <th>Time</th>
            <th>Max</th>
            <th>Time</th>
            <th>Value</th>
        </tr>
    `;

    // Biến đếm STT
    let rowIndex = 1;

    // Lặp qua từng năm
    years.forEach(year => {
        // Lặp qua các tháng từ 1 đến 12 và đảo ngược
        for (let month = 12; month >= 1; month--) {
            // Tìm số ngày trong tháng
            const daysInMonth = new Date(year, month, 0).getDate();

            // Lặp qua các ngày trong tháng từ cuối về đầu
            for (let day = daysInMonth; day >= 1; day--) {
                const dateKey = `${year}-${month}-${day}`;

                // Kiểm tra nếu có dữ liệu cho ngày hiện tại
                if (data['Monitoring'][year] && data['Monitoring'][year][month] && data['Monitoring'][year][month][day]) {
                    const sensorData = data['Monitoring'][year][month][day];

                    // Tạo hàng mới cho ngày hiện tại
                    const row = table1.insertRow();
                    row.innerHTML = `
                        <th rowspan="4">${rowIndex++}</th>
                        <th rowspan="4">${dateKey}</th>
                        <th rowspan="2">Temperature</th>
                        <td>(°C)</td>
                        <td>${sensorData.TemperatureC?.MIN || 'N/A'}</td>
                        <td>${sensorData.TemperatureC?.MIN_TIME || 'N/A'}</td>
                        <td>${sensorData.TemperatureC?.MAX || 'N/A'}</td>
                        <td>${sensorData.TemperatureC?.MAX_TIME || 'N/A'}</td>
                        <td>${sensorData.TemperatureC?.AVG ? parseFloat(sensorData.TemperatureC.AVG).toFixed(2) : 'N/A'}</td>
                    `;

                    const row2 = table1.insertRow();
                    row2.innerHTML = `
                        <td>(°F)</td>
                        <td>${sensorData.TemperatureF?.MIN || 'N/A'}</td>
                        <td>${sensorData.TemperatureF?.MIN_TIME || 'N/A'}</td>
                        <td>${sensorData.TemperatureF?.MAX || 'N/A'}</td>
                        <td>${sensorData.TemperatureF?.MAX_TIME || 'N/A'}</td>
                        <td>${sensorData.TemperatureF?.AVG ? parseFloat(sensorData.TemperatureF.AVG).toFixed(2) : 'N/A'}</td>
                    `;

                    const row3 = table1.insertRow();
                    row3.innerHTML = `
                        <td colspan="2">Humidity (%)</td>
                        <td>${sensorData.Humidity?.MIN || 'N/A'}</td>
                        <td>${sensorData.Humidity?.MIN_TIME || 'N/A'}</td>
                        <td>${sensorData.Humidity?.MAX || 'N/A'}</td>
                        <td>${sensorData.Humidity?.MAX_TIME || 'N/A'}</td>
                        <td>${sensorData.Humidity?.AVG ? parseFloat(sensorData.Humidity.AVG).toFixed(2) : 'N/A'}</td>
                    `;

                    const row4 = table1.insertRow();
                    row4.innerHTML = `
                        <td colspan="2">Smoke (%)</td>
                        <td>${sensorData.Smoke?.MIN || 'N/A'}</td>
                        <td>${sensorData.Smoke?.MIN_TIME || 'N/A'}</td>
                        <td>${sensorData.Smoke?.MAX || 'N/A'}</td>
                        <td>${sensorData.Smoke?.MAX_TIME || 'N/A'}</td>
                        <td>${sensorData.Smoke?.AVG ? parseFloat(sensorData.Smoke.AVG).toFixed(2) : 'N/A'}</td>
                    `;
                }
            }
        }
    });
}


    // Fire Log Table
function updateTable2(data) {
    const table2 = document.getElementById("alarmTable");
    table2.innerHTML = `
        <tr>
            <th>No.</th>
            <th>Date</th>
            <th>Sensor</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Duration</th>
            <th>Temp Average (°C)</th>
            <th>Temp Min (°C)</th>
            <th>Time Min</th>
            <th>Temp Max (°C)</th>
            <th>Time Max</th>
        </tr>
    `;

    let rowIndex = 1;

    // Hàm chuyển đổi thời gian thành giây
    function timeToSeconds(time) {
        const [hours, minutes, seconds] = time.split(':').map(Number);
        return hours * 3600 + minutes * 60 + seconds;
    }

    // Hàm chuyển đổi giây thành định dạng HH:MM:SS
    function secondsToTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Lọc và duyệt qua dữ liệu Fire_Log
    const fireLogs = data['Monitoring']['Fire_Log'];
    if (fireLogs) {
        Object.entries(fireLogs).reverse().forEach(([date, timeData]) => {
            Object.entries(timeData).reverse().forEach(([time, logData]) => {
                const row = table2.insertRow();

                const start_time_Second = timeToSeconds(logData.start_time || '00:00:00');
                const end_time_Second = timeToSeconds(logData.end_time || '00:00:00');
                const duration = secondsToTime(end_time_Second - start_time_Second);

                row.innerHTML = `
                    <th>${rowIndex++}</th>
                    <th>${date || 'N/A'}</th>
                    <th>Fire</th>
                    <td>${logData.start_time || '00:00:00'}</td>
                    <td>${logData.end_time || '00:00:00'}</td>
                    <td>${duration || '00:00:00'}</td>
                    <td>${parseFloat(logData.AVG).toFixed(2) || 'N/A'}</td>
                    <td>${logData.MIN || 'N/A'}</td>
                    <td>${logData.TIME_MIN || 'N/A'}</td>
                    <td>${logData.MAX || 'N/A'}</td>
                    <td>${logData.TIME_MAX || 'N/A'}</td>
                `;
            });
        });
    } else {
        console.log('No Fire Logs found');
    }
}






  </script>
</head>
<body>
  <!-- Main Monitoring Project  -->
  <div id="part1" class="main_content">
    <div class="container-fluid">
      <div class="row">

        <!-- LEFT -->
        <div class="col-2">
          <div class="task_table">
            <div class="logo_part">
              <div class="image_company">
                <img src="./assert/img/logo.png" alt="">
              </div>
              <div class="title">
                <h3>Monitoring Sensor</h3>
              </div>
            </div>

            <div class="menu_left">
              <ul>
                <li><p>Main</p></li>
                <li><p>Chart Line</p></li>
                <li><p>Excel</p></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="col-10">
          <div class="table_content">
            <div class="top_content">
              <div class="row">
                <div class="col-3">
                  <p>HEAD</p>
                </div>
                <div class="col-9">
                  <div class="button_log_out">
                    <p id="show_user"><i class="fa-solid fa-user"></i></p>
                    <button id="button_logout_user"><i class="fa-solid fa-right-from-bracket"></i></button>
                  </div>
                </div>
              </div>
            </div>


            <!-- Nút 1 -->
            <div id="dev1" class="bottom_content">
              <div class="line">
                <div class="row">
                  <div class="sensor_box col-4">
                    <div class="sensor_title">
                      
                      <h3>Sensor of Flame</h3>
                      <p id="status_Fire">off</p>
                      <button id="reset_fire">Reset</button>
                      <i class="fa-solid fa-fire"></i>
                  
                   
                      
                    </div>
                    <div class="insite_box a">
                      <div class="status" id="statusBox1">
                        <p id="text_status1">Không có lửa</p>
                      </div>
                      <div class="show_time">
                        <p id="date_detected"></p>
                        <p id="time_detected"></p>
                        <p id="fire_duration"></p>
                      </div>
                    </div>
                  </div>
                  
                  <div class="sensor_box col-3">
                    <div class="sensor_title">
                      <h3>Sensor of Smoke</h3>
                      <i class="fa-solid fa-smog"></i>
                    </div>
                    <div class="insite_box">
                      <div class="status" id="statusBox3">
                        <p id="text_status3">Không có lửa</p>
                      </div>
                    </div>
                  </div>
    
                  <div class="sensor_box col-5">
                    <div class="sensor_title">
                      <h3>Setting sensors thresholds</h3>
                      <button id="push_thresholds">PUSH</button>
                      <i class="fa-solid fa-gear"></i>
                    </div>
                    <!-- <div class="setting_on_off">
                      <div class="line1">
                        <button id="on_Fire">On Fire</button>
                        <button id="on_Temp_Humi">On Temp & Humi</button>
                        <button id="on_Smoke">On Smoke</button>
                      </div>
                      <div class="line2">
                        <button id="off_Fire">Off Fire</button>
                        <button id="off_Temp_Humi">Off Temp & Humi</button>
                        <button id="off_Smoke">Off Smoke</button>
                      </div>
                     
                    </div> -->
                    
                    <div class="insite_box">
                      <div class="row">
                        <div class="col-6">
                          <div class="threshold_input">
                            <p>TempC Max:  </p>
                            <input type="number" id="tempCMax" min="0" max="60" placeholder="60">
                          </div>
                          <div class="threshold_input">
                            <p>TempF Max:  </p>
                            <input type="number" id="tempFMax" min="32" max="122" placeholder="100">
                          </div>
                          <div class="threshold_input">
                            <p>Humi Max:   </p>
                            <input type="number" id="humiMax" min="0" max="60" placeholder="100">
                          </div>
                        </div>

                        <div class="col-6">
                          <div class="threshold_input">
                            <p>TempF Min:</p>
                            <input type="number" id="tempCMin" min="0" max="60" placeholder="0">
                          </div>
                          <div class="threshold_input">
                            <p>TempF Min:</p>
                            <input type="number" id="tempFMin" min="32" max="122" placeholder="0">
                          </div>
                          <div class="threshold_input">
                            <p>Humi Min:</p>
                            <input type="number" id="humiMin" min="0" max="60" placeholder="0">
                          </div>
                        </div>
                      </div>
                      
                      
                    </div>
                    
                  </div>
      
                  
                </div>
              </div>
              <div class="line2">
                <div class="row">
                  <div class="sensor_box col-6">
                    <div class="sensor_title">
                      <h3>Temperature Chart</h3>
                      <i class="fa-solid fa-temperature-three-quarters"></i>
                    </div>
                    <div class="insite_box">
                      <div class="status" id="statusBox_temp">
                        <canvas id="myChart1"></canvas>
                      </div>
                    </div>
                  </div>
                  <div class="sensor_box col-6">
                    <div class="sensor_title">
                      <h3>Humidity Chart</h3>
                      <i class="fa-solid fa-temperature-three-quarters"></i>
                    </div>
                    <div class="insite_box">
                      <div class="status" id="statusBox_temp">
                        <canvas id="myChart2"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>



            <!-- Nút 2 -->
            <div id="dev2" class="bottom_content">
              <div class="line">
                <div class="row">
                  <div class="sensor_box_web2_1 col-12">
                    <div class="sensor_title">
                      <h3>Temperature Chart</h3>
                      <i class="fa-solid fa-temperature-three-quarters"></i>
                    </div>
                    <div class="insite_box2">
                      <div class="status" id="statusBox_temp_web2">
                        <canvas id="myChart3" ></canvas>
                      </div>
                    </div>
                  </div>
                </div>
    
                <div class="row">
                  <div class="sensor_box_web2_2 col-12">
                    <div class="sensor_title">
                      <h3>Humidity Chart</h3>
                      <i class="fa-solid fa-temperature-three-quarters"></i>
                    </div>
                    <div class="insite_box2">
                      <div class="status" id="statusBox_humi_web2">
                        <canvas id="myChart4"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <!-- Nút 3 -->
            <div id="dev3" class="bottom_content">
              <div class="line">
                <div class="row">
                  <div class="sensor_box_web2_1 col-12">
                    <div class="sensor_title">
                      <h3>Table of all Sensor</h3>
                      <button id="infor_Table">Sensor Information Table</button>
                      <button id="alarm_Table">Fire Log Table</button>

                      <i class="fa-solid fa-table"></i>
                    </div>
                    
                  </div>
                </div>
    
                <div class="row">
                  <div class="col-12">

                    <!-- Table 1: Temp & Humi & Smoke -->
                    <div class="insite_box2" id="table1">
                      <table id="myTable">
                        <tr>
                          <th rowspan="3">STT</th>
                          <th rowspan="3">Date</th>
                          <th rowspan="3" colspan="2">Name sensor</th>
                          <th colspan="7">Information</th>
                        </tr>
                        
                        <tr>
                          <th colspan="2">Min - Time</th>
                          <th colspan="2">Max - Time</th>
                          <th>AVG</th>
                          <th colspan="2">Max - Time</th>
                        </tr>
                        <tr>
                          
                          <th>Min</th>
                          <th>Time</th>
                          <th>Max</th>
                          <th>Time</th>
                          <th>Value</th>
                          <th>True/False</th>
                          <th>Time</th>
                      
                        </tr>

                      </table>
                    </div>

                    <!-- Table 2: Fire Log -->
                    <div class="insite_box2" id="table2" style="display: none;">
                      <div class="setting_alarm">
                        <i class="fa-solid fa-gear" aria-hidden="true"></i>
                        <button></button>
                      </div>
                      <table id="alarmTable">
                          <tr>
                              <th>STT</th>
                              <th>Sensors</th>
                              <th>True/False</th>
                              <th>Time</th>
                              <th>Alarm</th>
                          </tr>
                          
                      </table>
                    </div>

                  </div>
                </div>
              </div>
            </div>




          </div>
        </div>
      </div>
    </div>
  </div>




 <script>


  function openModal2() {
      document.getElementById("log_out").style.display = "flex";
      document.body.classList.add("modal-active");
  }

  // Đóng modal
  function closeModal2() {
      document.getElementById("log_out").style.display = "none";
      document.body.classList.remove("modal-active");
  }
  // Đóng modal khi nhấp ra ngoài hộp nội dung
  // window.onclick = function(event) {
  //     if (event.target == document.getElementById("loginModal")) {
  //         closeModal();
  //     }
  // }
  // window.onload = function() {
  //       const isLoggedIn = sessionStorage.getItem("isLoggedIn");

  //       // Nếu người dùng chưa đăng nhập, chuyển hướng về trang đăng nhập
  //       if (isLoggedIn !== "true") {
  //           alert("Bạn cần đăng nhập để truy cập trang này");
  //           // window.location.href = "index.html"; // Chuyển hướng về trang đăng nhập
  //       }
  //   };
</script> 
</body>
</html>

















